var map;
var base_lat = 35.645335; // KVH Tamachi office latitiude
var base_long = 139.748545; // KVH Tamachi office longitude
var last_infowin = new Array();
var emp_id = <%= @employee.id%>

$(function($){
  var latlng = new google.maps.LatLng(base_lat, base_long);
  var opts = {
    zoom: 15,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    center: latlng
  };

  map = new google.maps.Map(document.getElementById("map"), opts);
  $.get("/employees/" + emp_id + "/restaurants/index_get_commented_restaurants_all",
      function(res){
	  for(i=0; i < res.length; i++){
              var markerOpts = {
                  position: new google.maps.LatLng(res[i].latitude, res[i].longitude),
                  map:map,
                  title: res[i].name
              };
              var marker = new google.maps.Marker(markerOpts);
	  };
  });
});

function markonmap(lat, lon, name) {
  var restaurant_location = {
        position: new google.maps.LatLng(lat, lon),
        content: name
  };
  var infowin = new google.maps.InfoWindow(restaurant_location);
  last_infowin.push(infowin);
  infowin.open(map);
}

function unmarkonmap() {
  for (i = 0; i < last_infowin.length; i++) {
    last_infowin[i].close();
    last_infowin.shift;
  }
}

function search_restaurant() {
  var emp_id = <%= @employee.id%>
  $("#restaurant_info").empty();
  $("#spinner").show();
  unmarkonmap();
  var keyword = $("#search_box_lunch").val();

  // To fill the gap of search speed between local and tabelog database, delay showing results
  setTimeout(function(){
  $.get("/employees/" + emp_id + "/restaurants/search_restaurant", {query:keyword},
    function(result){
        $("#spinner").hide();
	$("#restaurant_info").prepend(result.html);
	readonly_raty();
	modifiable_raty();
        $("#search_box_lunch").val("");
    }
  );
  }, 500);
}

function readonly_raty(){
    $('.rating_readonly').each(function(index, domEle){
        var restaurant_rating = $(domEle).attr("readonly_score");
        $(domEle).raty({
        	path: '/assets',
        	readOnly:true,
    	scoreName: 'readonly_score',
        	start: restaurant_rating
        });
    });
}

function modifiable_raty(){
    $('.rating').raty({
    	path: '/assets'
    });
}

$(function($){
    var latitude;
    var longitude;
    var name;
    $(".each_restaurant:first").css("background-color", "#FFFFE1");
    readonly_raty();
    modifiable_raty();
});

$(function($){
    $(".button").click(function(){
        var direction = $(this).attr("name");
        var each_image_width = 50;
	var parnt = $(this).parent();
        var numofposts = parnt.find(".numberofposts").text();
        var posts_width = parseInt(numofposts) * each_image_width;
        var val = parnt.find("table").css("marginLeft");
        var box_width = 250;

        if (direction == "left") {
            var new_val = parseInt(val) + each_image_width;
            var hidden_width = posts_width + new_val;
            if ((hidden_width >= box_width ) && (parseInt(val) < 0)) {
                var pixel = new_val + "px";
                parnt.find("table:not(:animated)").animate({
                    marginLeft:pixel,
                }, "normal", "swing")
            }        
        } else if (direction == "right") {
            var new_val = parseInt(val) - each_image_width;
            var hidden_width = posts_width + new_val;
            if (hidden_width >= box_width ) {
                var pixel = new_val + "px";
                parnt.find("table:not(:animated)").animate({
                    marginLeft:pixel,
                }, "normal", "swing")
            }
        }
    });
});

$(function($){
    $(".submit_restaurant_post_button input").live("click", function(){
        var parnt = $(this).parents(".each_restaurant")
        var emp_id = <%= @employee.id%>
	var rst_id = parnt.attr("name")
	var message = parnt.find(".new_post textarea").val();
        var rating = parnt.find("[name=score]", "input").attr("value")
        $.ajax({
	    type: 'post',
	    url: '/employees/' + emp_id + '/restaurants/' + rst_id + '/posts_restaurants/',
	    data: {
		    'topic':'Restaurant',
		    'topic_id':rst_id,
		    'employee_id':emp_id,
		    'message':message,
		    'rating':rating
	    },
	    success: function(html){
                parnt.find(".new_post textarea").val("");
		parnt.find(".rating").raty('cancel', true);
	    }
        });
    });
});

$(function($){
    var latitude;
    var longitude;
    var name;
    var selected_restaurant;
    $(".each_restaurant").live("click", function(){
    if ($(this).get(0) != selected_restaurant) {
       var emp_id = <%= @employee.id%>
       var res_id = $(this).attr("name")

       $(".each_restaurant").css("background-color", "#FFFFFF");
       $(this).css("background-color", "#FFFFE1");

       $.get("/employees/" + emp_id + "/restaurants/index_get_restaurant_record", {restaurant_id:res_id},
           function(result_json){
               latitude = result_json.latitude;
               longitude = result_json.longitude;
               name = result_json.name;
	       map.panTo(new google.maps.LatLng(latitude, longitude));
               unmarkonmap();
	       markonmap(latitude, longitude, name);
       });
       selected_restaurant = $(this).get(0);
    }
    });
});
