var map;
var base_lat = 35.645335; // KVH Tamachi office latitiude
var base_long = 139.748545; // KVH Tamachi office longitude
var last_infowin = new Array();

$(function($){
  var latlng = new google.maps.LatLng(base_lat, base_long);
  var opts = {
    zoom: 15,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    center: latlng
  };

  map = new google.maps.Map(document.getElementById("map"), opts);

  var infoWindowOpts = {
        position: new google.maps.LatLng(base_lat, base_long),
        content: "Test Test Test"
  };
  var infowin = new google.maps.InfoWindow(infoWindowOpts);
  infowin.open(map);
});

function markonmap(lat, lon, name) {
  var restaurant_location = {
        position: new google.maps.LatLng(lat, lon),
        content: name
  };
  var infowin = new google.maps.InfoWindow(restaurant_location);
  last_infowin.push(infowin);
  infowin.open(map);
}

function unmarkonmap() {
  for (i = 0; i < last_infowin.length; i++) {
    last_infowin[i].close();
    last_infowin.shift;
  }
}

function search_restaurant() {
  var emp_id = <%= @employee.id%>

  unmarkonmap();
  $("#search_result_lunch_imagelist").empty();
  var keyword = $("#search_box_lunch").val();
  $.get("/employees/" + emp_id + "/restaurants/search_restaurant", {query:keyword},
    function(result){
      for (i = 0; i < result.length; i++) {
        r = result[i];
    var res_id = r.id;
        var res_lat = parseFloat(r.latitude);
        var res_lon = parseFloat(r.longitude);
        var res_name = r.name;
        var res_image = r.image;
        markonmap(res_lat, res_lon, res_name);
    $.get("/employees/" + emp_id + "/restaurants/get_restaurant_review_html", {id:res_id},
          function(result_html){
            $("#search_result_lunch_imagelist").append(result_html);
      });
        $("#search_box_lunch").val("");
      }
  });
}

$(function($){
    var emp_id = <%= @employee.id %>
    $(".each_restaurant_review").click(function(){
	$(this).parent().find(".each_restaurant_review_image img").css("border", "2px solid #FFFFFF");
	$(this).find(".each_restaurant_review_image img").css("border", "2px solid #498BF4");
        var comment = $(".each_restaurant_review_comment", this).text();
        var post_id = $(this).attr("name");
        var rest_id = $(this).find(".each_restaurant_review_image").attr("name");
            $.get("/employees/" + emp_id + "/restaurants/index_get_active_message", {post_id:post_id},
                    function(result_json){
            $(".comment_display_area" + rest_id).text(result_json);
            });
    });

});

$(function($){
    $(".button").click(function(){
        var direction = $(this).attr("name");
        var each_image_width = 50;
	var parnt = $(this).parent();
        var numofposts = parnt.find(".numberofposts").text();
        var posts_width = parseInt(numofposts) * each_image_width;
        var val = parnt.find("table").css("marginLeft");
        var box_width = 250;

        if (direction == "left") {
            var new_val = parseInt(val) + each_image_width;
            var hidden_width = posts_width + new_val;
            if ((hidden_width >= box_width ) && (parseInt(val) < 0)) {
                var pixel = new_val + "px";
                parnt.find("table:not(:animated)").animate({
                    marginLeft:pixel,
                }, "normal", "swing")
            }        
        } else if (direction == "right") {
            var new_val = parseInt(val) - each_image_width;
            var hidden_width = posts_width + new_val;
            if (hidden_width >= box_width ) {
                var pixel = new_val + "px";
                parnt.find("table:not(:animated)").animate({
                    marginLeft:pixel,
                }, "normal", "swing")
            }
        }
    });
});
