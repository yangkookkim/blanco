var imageid = 0;

function upload_image(){
	var grp_id = <%= @group.id %>;
	var emp_id = <%= @employee.id %>;
	var url = "/employees/"+ emp_id +"/groups/"+ grp_id +"/posts"
	
    $('#upload').upload(
    url, 
    {"employee_id":emp_id, "group_id":"grp_id", "type":"image"},
    function (res) {
    	image = res.image
    	thumb = image.thumb
    	imageurl = thumb.url
    	imageid = res.id
    	html = '<img alt="The image you uploaded" height="100" src="'+ imageurl +'"  width="100" />';
    	$("#display_image").html(html);
    },
    	'json'
    );
}

function submit_post(f){
	var grp_id = <%= @group.id %>;
	var emp_id = <%= @employee.id %>;
    var val = $("#input").val();
    var data_json = {
        			  "channel":{"id":grp_id},
        		   	  "post":{"message":val, "employee_id":emp_id, "group_id":grp_id, "img_id":imageid},
        		   	  "ops":"sendmsg"
	};
	var data_str = JSON.stringify(data_json);
	// Send data to websocket
	ws.send(data_str);
	$("#input").val("");
	imageid = 0;
}

$(function(){
    ws = new WebSocket("ws://localhost:51234");
    var id = <%= @group.id %>;
    var expr = /(\r\n|\r|\n)/g
    ws.onmessage = function(evt) {
    	if (evt.data) {
			var json = $.parseJSON(evt.data)
			var post = json.post
			var employee = json.employee

		    var txt = post.message
		    txt = txt.replace(/\r\n/g, '\n');
		    txt = txt.replace(/\r/g, '\n');
		    var lines = txt.split('\n');
		
    	if (post.image.url == null) {
    		imagehtml = "";
    	} else {
    		imageurl = post.image.thumb.url;
    		imagehtml = '<img alt="The image you uploaded" height="100" src="'+ imageurl +'"  width="100" />';
    	}
    			    
		var post_html = $("<li/>").attr("class", "post")
		$(post_html).append($("<div/>").addClass("post_header"))
		$("div.post_header", post_html).append($("<span/>").addClass("post_header_image"))
		$("span.post_header_image", post_html).after($("<span/>").addClass("post_header_senderinfo").text(employee.name + ' wrote at ' + post.created_at))
		$(post_html).append($($("<div/>").addClass("post_image")).html(imagehtml))
		$("div.post_image", post_html).after($($("<div/>").addClass("post_message")))
		$("div.post_message", post_html).append($("<p/>"))

		    $("#posts").prepend(post_html)
		    for (var i = 0; i < lines.length; i++) { // > dummy tag
		      if (0 < i) { // > dummy tag
		        $(".post:first p").append('<br />');
		      };
		      $(".post:first p").append(document.createTextNode(lines[i]));
		    };
		    $("#display_image").html("");
    	};
    };

    ws.onclose = function() {
        console.log("closing...-client side")
    };

    ws.onopen = function() {
    	var grp_id = <%= @group.id %>;
		var emp_id = <%= @employee.id %>;
        var data_json = {
        				  "channel":{"id":grp_id},
        				  "post":{"message":"", "employee_id":emp_id, "group_id":grp_id, "img_id":imageid},
        				  "ops":"setupcon"
        				};
        var data_str = JSON.stringify(data_json);
        ws.send(data_str);
        imageid = 0;
    };		    	
});
