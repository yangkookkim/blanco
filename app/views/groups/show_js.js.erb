var postid = null;

$(function($){
    $("#upload").change(function(){ 
    $("#spinner").show();
    upload_image();
      });
});

$(function(){
    $(".delete_post_button").live("click", function(){
        var grp_id = <%= @group.id %>;
        var emp_id = <%= @employee.id %>;
        var pst_id = $(this).attr("name");
        var url = "/posts/"+ pst_id;

        var data_json = {
                      "channel":{"id":grp_id},
                         "post":{"message":null, "employee_id":emp_id, "group_id":grp_id, "id":pst_id},
                         "operation":"deletepost"
        };
        var data_str = JSON.stringify(data_json);
        ws.send(data_str);
    });
});

function upload_image(){
    var grp_id = <%= @group.id %>;
    var emp_id = <%= @employee.id %>;
    var url = "/tempimages"
    
    $('#upload').upload(
    url, 
    {},
    function (tempimage) {
        image = tempimage.image
	html = '<img alt="The image you uploaded" height="100" src="'+ image.url +'"'
	       + 'name="'+ tempimage.id + '"' +  'width="100" />';
        $("#display_image").html(html);
        $("#spinner").hide();
    },
        'json'
    );
}

function submit_post(f){
    var grp_id = <%= @group.id %>;
    var emp_id = <%= @employee.id %>;
    var val = $("#input").val();
    var tmpimg_id;
    tmpimg_id = $("#display_image img").attr("name");

    $.ajax({
	    type: 'post',
	    url: '/employees/' + emp_id + '/groups/' + grp_id + '/posts_groups/',
	    data: {
		    'topic':'Group',
		    'topic_id':grp_id,
		    'employee_id':emp_id,
	            'tempimage_id':tmpimg_id,
		    'message':val
	    },
	    success: function(html){
		    $("#posts").prepend(html);
                    $("#input").val("");
		    var post_id = parseInt($(html, ".post").attr("name"));
                    var data_json = {
                      "operation":"publish",
	              "channel":"groups:" + grp_id,
		      "message":{
		        "topic":"posts",
		        "id":post_id
		      }
                    };
                    var data_str = JSON.stringify(data_json);
                    // Send data to websocket
                    ws.send(data_str);
	    }
    });
    //
    //// TODO update message should be sperated
    //// Send update notification
    //var update_json = {
    //                  "channel":{"id":grp_id},
    //                  "post":{"message":val, "employee_id":emp_id, "group_id":grp_id, "id":postid},
    //                  "operation":"update"
    //};
    //var update_str = JSON.stringify(update_json);
    ////monitor_posts_ws.send(update_str);
    //
    //$("#input").val("");
    //postid = null;
}

$(function(){
    //ws = new WebSocket("ws://websocket.servebeer.com:443");
    ws = new WebSocket("ws://localhost:10000");
    var grp_id = <%= @group.id %>;
    var emp_id = <%= @employee.id %>;

    ws.onmessage = function(evt) {
        console.log(evt.data);
        var json = $.parseJSON(evt.data)
	var pst_id = json.post.id

        if ((evt.data) && (emp_id != json.post.employee_id)) {
            $.ajax({
	        type: 'get',
	        url: '/employees/' + emp_id + '/groups/' + grp_id + '/posts/' + pst_id,
	        data: {
	            'id':pst_id,
	        },
	        success: function(html){
	            $("#posts").prepend(html);
	        }
	    });
        };
    };

    ws.onclose = function() {
        console.log("closing...-client side")
    };

    ws.onopen = function() {
        var grp_id = <%= @group.id %>;
        var emp_id = <%= @employee.id %>;
	var channel = "groups:" + grp_id;
        var data_json = {
                          "channel":channel,
                          "post":{"message":"", "employee_id":emp_id, "group_id":grp_id, "img_id":postid},
                          "operation":"subscribe"
                        };
        var data_str = JSON.stringify(data_json);
        ws.send(data_str);
        postid = null;
    };                
});
