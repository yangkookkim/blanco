<script type="text/javascript">
function save(f){
  $.ajax({
    url: $(f).attr('action'),
    type: 'POST',
    dataType: 'json',
    timeout: 1000,
    data : $(f).serialize(),
    beforeSend : function(){ $('#post_status').html('送信中...').fadeIn(200); },
    error: function(){alert('Error Occured');},
    success: function(obj){
	if(obj.error){
        var html = '';
        $(obj.error).each(function(){ html += this[1] + '<br />'; });
        $('#post_status').text(html).css("color", 'red');
      }else if(obj.success){
        $("#posts").prepend(obj.html);
        $('#lastpost_id').text(obj.lastpost_id);
        $('#post_status').text('正常に登録しました').css("color", 'green');
        //$(':input').not(':submit').val('');
      }
    }
  });
  return false;
}

function checkupdate_ajax(){
	$.get("http://localhost:2000/employees/1/groups/1/checkupdate_ajax", {lastpost_id:$('#lastpost_id').text()}, function(data){
		if (data.updated != 0){
			var i = 0;
			for (i in data.new_posts){
				var new_post = "<div class=post>" + data.new_posts[i].message + "</div>";
				$("#posts").prepend(new_post);
			}
			$("#lastpost_id").text(data.new_posts[i].id);	
		}else{
			//alert("noupdate");
		}
	});
}
setInterval("checkupdate_ajax()", 5000);
</script>
<button onclick=checkupdate_ajax()>check</button><br>
<div id="lastpost_id"><%= @lastpost_id %></div>
<%= form_for @new_post, :html => {:onSubmit => "return save(this);"} do |f| %>
    <%= f.text_area :message, 'cols' => 40, 'rows' => 5 %>
	<%= f.hidden_field :employee_id, :value => @employee_id %>
	<%= f.hidden_field :group_id, :value => @group_id %>
 <%= f.submit "投稿" %>
 <div id="post_status" style="display:none;"></div>
<% end %>

<%#
  ### When :collection is passed array object, partial file takes each element of array and sets it to local variable with the name of partial file.
  ### In this case, partial file "_post.html.erb" creates variable "post" with each element of "@posts". Then it renders partial page with each "page".
%>
<div id="posts" >
<%= render :partial => "/post/each_post", :collection => @posts %>
</div>
