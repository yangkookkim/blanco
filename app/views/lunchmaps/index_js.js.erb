var map;
var base_lat = 35.645335; // KVH Tamachi office latitiude
var base_long = 139.748545; // KVH Tamachi office longitude
var last_infowin = new Array();

$(function($){
  var latlng = new google.maps.LatLng(base_lat, base_long);
  var opts = {
    zoom: 15,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    center: latlng
  };

  map = new google.maps.Map(document.getElementById("map"), opts);

  var infoWindowOpts = {
        position: new google.maps.LatLng(base_lat, base_long),
        content: "Test Test Test"
  };
  var infowin = new google.maps.InfoWindow(infoWindowOpts);
  infowin.open(map);
});

function markonmap(lat, lon, name) {
  var restaurant_location = {
        position: new google.maps.LatLng(lat, lon),
        content: name
  };
  var infowin = new google.maps.InfoWindow(restaurant_location);
  last_infowin.push(infowin);
  infowin.open(map);
}

function unmarkonmap() {
  for (i = 0; i < last_infowin.length; i++) {
    last_infowin[i].close();
    last_infowin.shift;
  }
}

function search_restaurant() {
  var emp_id = <%= @employee.id%>

  unmarkonmap();
  $("#search_result_lunch_imagelist").empty();
  var keyword = $("#search_box_lunch").val();
  $.get("/employees/" + emp_id + "/lunchmaps/search_restaurant", {query:keyword},
    function(result){
      for (i = 0; i < result.length; i++) {
        r = result[i];
	var res_id = r.id;
        var res_lat = parseFloat(r.latitude);
        var res_lon = parseFloat(r.longitude);
        var res_name = r.name;
        var res_image = r.image;
        markonmap(res_lat, res_lon, res_name);
	$.get("/employees/" + emp_id + "/lunchmaps/get_restaurant_review_html", {id:res_id},
          function(result_html){
            $("#search_result_lunch_imagelist").append(result_html);
	  });
        $("#search_box_lunch").val("");
      }
  });
}
